#!/bin/sh

# Check for any unstaged changes in tracked files
MODIFIED_UNSTAGED_FILES=$(git diff --name-only)
if [ -n "$MODIFIED_UNSTAGED_FILES" ]; then
  echo "Error: There are unstaged changes in tracked files:" >&2
  echo "$MODIFIED_UNSTAGED_FILES" >&2
  echo "Please stage all relevant files before committing." >&2
  exit 1
fi

# Check for any new, untracked files (that are not ignored)
NEW_UNTRACKED_FILES=$(git ls-files --others --exclude-standard)
if [ -n "$NEW_UNTRACKED_FILES" ]; then
  echo "Error: There are new untracked files:" >&2
  echo "$NEW_UNTRACKED_FILES" >&2
  echo "Please stage or gitignore these files before committing." >&2
  exit 1
fi

# Staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if someone is trying to edit the legacy DEVLOG.md or TASKS.md files
devlog_staged=$(echo "$STAGED_FILES" | grep -c "DEVLOG.md" || true)
tasks_staged=$(echo "$STAGED_FILES" | grep -c "TASKS.md" || true)

if [ "$devlog_staged" -gt 0 ] || [ "$tasks_staged" -gt 0 ]; then
  echo "ERROR: Direct modification of DEVLOG.md and TASKS.md is no longer allowed!" >&2
  echo "" >&2
  echo "📍 NEW WORKFLOW: These files have been restructured to eliminate merge conflicts." >&2
  echo "" >&2
  echo "Instead of editing these files directly:" >&2
  echo "" >&2
  echo "✅ For development log entries:" >&2
  echo "   - Create a new file in docs/_devlogs/ with format: {YYYY-MM-DD}-{description}.md" >&2
  echo "   - Include YAML front matter with title, date, author, and tags" >&2
  echo "   - See: https://anicolao.github.io/morpheum/documentation/contributing/" >&2
  echo "" >&2
  echo "✅ For new tasks:" >&2
  echo "   - Create a new file in docs/_tasks/ with format: task-{number}-{description}.md" >&2
  echo "   - Include YAML front matter with title, order, status, phase, and category" >&2
  echo "   - See: https://anicolao.github.io/morpheum/documentation/contributing/" >&2
  echo "" >&2
  echo "🔗 Unified views are automatically generated at:" >&2
  echo "   - Tasks: https://anicolao.github.io/morpheum/status/tasks/" >&2
  echo "   - Devlogs: https://anicolao.github.io/morpheum/status/devlogs/" >&2
  echo "" >&2
  echo "This change prevents merge conflicts and enables unlimited concurrent contributors." >&2
  exit 1
fi


exit 0
