# Setting Up a Delegated Matrix Homeserver on NixOS

This guide provides a complete, step-by-step process for setting up a Matrix homeserver using Conduit on NixOS, generated by Gemini.

The goal of this configuration is to achieve **delegation**, where the homeserver runs on a subdomain (e.g., `matrix.morpheum.dev`) while user IDs are on the root domain (e.g., `@username:morpheum.dev`). This is a robust and flexible setup that separates user identity from the physical server host.

This guide assumes:
* Your homeserver will be at `matrix.morpheum.dev`.
* Your user-facing domain will be `morpheum.dev`.
* You are using Cloudflare for DNS and GitHub Pages for the root domain's web hosting.

---

### ## Step 1: Cloudflare DNS Configuration

The first step is to correctly configure DNS records to route traffic for both the homeserver and the root domain.

#### ### Records for the Homeserver (`matrix.morpheum.dev`)

This is the actual address of your server, which will be updated by a Dynamic DNS (DDNS) client.

| Type | Name     | Content     | Proxy Status      |
| :--- | :------- | :---------- | :---------------- |
| A    | `matrix` | `192.0.2.1` | **DNS only** (Grey) |

**Note:** The Cloudflare proxy (orange cloud) **must be disabled** for Matrix federation to work correctly.

#### ### Records for the User Domain (`morpheum.dev`)

These records point your root domain to GitHub Pages and tell the Matrix network where to find your server for federation.

| Type  | Name        | Content                    |
| :---- | :---------- | :------------------------- |
| A     | `@`         | `185.199.108.153`          |
| A     | `@`         | `185.199.109.153`          |
| A     | `@`         | `185.199.110.153`          |
| A     | `@`         | `185.199.111.153`          |
| SRV   | _see below_ | _see below_                |

**SRV Record Details:**
This record is crucial for server-to-server federation. It delegates requests for `morpheum.dev` to your actual homeserver.

| Service          | Proto | Name  | Priority | Weight | Port | Target                  |
| :--------------- | :---- | :---- | :------- | :----- | :--- | :---------------------- |
| `_matrix-server` | `_tcp`  | `@`   | 10       | 10     | 443  | `matrix.morpheum.dev` |

---

### ## Step 2: GitHub Pages `.well-known` Configuration

To allow Matrix clients to discover your server when a user tries to log in with `morpheum.dev`, you must place a delegation file in your GitHub Pages repository.

**1. Create the File and Directory Structure:**
In the root of your GitHub Pages repository, create the following:
`/.well-known/matrix/client`

**2. Add the File Content:**
The content of the `client` file must be the following JSON object:

```json
{
    "m.homeserver": {
        "base_url": "https://matrix.morpheum.dev"
    }
}
```

**3. Deploy to GitHub Pages:**
Commit and push this new file to your repository's main branch.

```shell
git add .well-known/matrix/client
git commit -m "Add Matrix .well-known delegation file"
git push
```

**4. Verify:**
After your site deploys, you should be able to visit `https://morpheum.dev/.well-known/matrix/client` and see the JSON content.

---

### ## Step 3: NixOS Server Configuration

Update your `configuration.nix` file to reflect this delegated setup. The key is that **Conduit's `server_name`** is your user domain, but **Nginx's `virtualHost`** is your server's actual hostname.

```nix
# /etc/nixos/configuration.nix
{ config, pkgs, ... }:

{
  # 1. Conduit Homeserver Configuration
  services.conduit = {
    enable = true;
    settings = {
      # The server_name is the public-facing domain for user IDs.
      server_name = "morpheum.dev";
      # Listen on localhost; Nginx will handle external traffic.
      address = "127.0.0.1";
      port = 6167;
      # Allow federation with the main matrix.org server.
      trusted_servers = [ "matrix.org" ];
    };
  };

  # 2. Cloudflare Dynamic DNS Updater for the homeserver host.
  services.cloudflare-ddns = {
    enable = true;
    credentialsFile = "/path/to/your/cloudflare.ini";
    domains = [ "matrix.morpheum.dev" ];
  };

  # 3. Nginx Reverse Proxy & Automatic SSL (ACME) for the homeserver host.
  services.nginx = {
    enable = true;
    virtualHosts."matrix.morpheum.dev" = {
      forceSSL = true;
      enableACME = true;
      locations = {
        "/_matrix" = {
          proxyPass = "[http://127.0.0.1:6167](http://127.0.0.1:6167)";
          proxyWebsockets = true;
          extraConfig = ''
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host $host;
          '';
        };
        "/_synapse/client" = {
          proxyPass = "[http://127.0.0.1:6167](http://127.0.0.1:6167)";
          proxyWebsockets = true;
          extraConfig = ''
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host $host;
          '';
        };
        # This server-side .well-known is for federation validation.
        "/.well-known/matrix/server" = {
          return = 200 '{ "m.server": "matrix.morpheum.dev:443" }';
          extraConfig = "add_header Content-Type application/json;";
        };
      };
    };
  };

  # Enable the ACME service for Let's Encrypt.
  security.acme = {
    acceptTOS = true;
    defaults.email = "your-email@example.com";
  };

  # 4. Firewall Configuration
  networking.firewall = {
     allowedTCPPorts = [ 80, 443 ];
  };
}
```

---

### ## Step 4: Final Deployment and Verification

1.  **Create the Cloudflare credentials file** specified in your NixOS config. Ensure it is secure (`sudo chmod 600 /path/to/your/cloudflare.ini`).

2.  **Apply the configuration:**
    ```shell
    sudo nixos-rebuild switch
    ```

3.  **Verify your setup:** Use the **Matrix Federation Tester** at `https://federationtester.matrix.org/`. Enter `morpheum.dev` as the server name. The tool should correctly follow the delegation path and show a success report for `matrix.morpheum.dev`.

4.  **Create your first user:**
    ```shell
    # Usage: conduit-admin create-user <username> <password>
    conduit-admin create-user my-username 'a-very-strong-password'
    ```

You can now log in from any Matrix client by specifying `morpheum.dev` as your homeserver. Your user ID will be correctly formatted as `@my-username:morpheum.dev`.
