# Setting Up a Delegated Matrix Homeserver on NixOS

This guide provides a complete, step-by-step process for setting up a Matrix homeserver using Conduit on NixOS, generated by Gemini and debugged over an afternoon.

The goal of this configuration is to achieve **delegation**, where the homeserver runs on a subdomain (e.g., `matrix.morpheum.dev`) while user IDs are on the root domain (e.g., `@username:morpheum.dev`). This is a robust and flexible setup that separates user identity from the physical server host.

This guide assumes:
* Your homeserver will be at `matrix.morpheum.dev`.
* Your user-facing domain will be `morpheum.dev`.
* You are using Cloudflare for DNS and GitHub Pages for the root domain's web hosting.

---

### ## Step 1: Cloudflare DNS Configuration

The first step is to correctly configure DNS records to route traffic for both your root domain and your subdomain.

#### ### A Records

You need two sets of A records: one for your homeserver (which will be updated by DDNS) and one for your root domain pointing to GitHub Pages.

| Type | Name     | Content     | Proxy Status      | Purpose                |
| :--- | :------- | :---------- | :---------------- | :--------------------- |
| A    | `matrix` | `192.0.2.1` | **DNS only** (Grey) | Your homeserver's IP.  |
| A    | `@`      | `185.199.108.153` | Proxied (Orange)    | GitHub Pages IP.       |
| A    | `@`      | `185.199.109.153` | Proxied (Orange)    | GitHub Pages IP.       |
| A    | `@`      | `185.199.110.153` | Proxied (Orange)    | GitHub Pages IP.       |
| A    | `@`      | `185.199.111.153` | Proxied (Orange)    | GitHub Pages IP.       |

#### ### SRV Records for Federation and Delegation

To ensure maximum compatibility with all Matrix servers (both old and new), it is best practice to include three SRV records. This resolves the confusion between the different names.

| Type | Name     | Service          | Proto | Priority | Weight | Port | Target                  | Purpose                                                              |
| :--- | :------- | :--------------- | :---- | :------- | :----- | :--- | :---------------------- | :------------------------------------------------------------------- |
| SRV  | `@`      | `_matrix-server` | `_tcp`  | 10       | 10     | 443  | `matrix.morpheum.dev` | **Modern standard** for servers discovering `morpheum.dev` directly. |
| SRV  | `matrix` | `_matrix-fed`    | `_tcp`  | 10       | 10     | 443  | `matrix.morpheum.dev` | **Modern standard** for servers that are *delegated* to `matrix.morpheum.dev`. |
| SRV  | `@`      | `_matrix`        | `_tcp`  | 20       | 10     | 443  | `matrix.morpheum.dev` | **Legacy fallback** for older servers to ensure they can find you.     |

---

### ## Step 2: GitHub Pages `.well-known` Configuration

To allow Matrix clients to discover your server when a user tries to log in with `morpheum.dev`, you must place a delegation file in your GitHub Pages repository.

**1. Create the File and Directory Structure:**
In the root of your GitHub Pages repository, create the following:
`/.well-known/matrix/client`

**2. Add the File Content:**
The content of the `client` file must be the following JSON object:

```json
{
    "m.homeserver": {
        "base_url": "[https://matrix.morpheum.dev](https://matrix.morpheum.dev)"
    }
}
```

**3. Deploy to GitHub Pages:**
Commit and push this new file to your repository's main branch.

---

### ## Step 3: NixOS Server Configuration

This is the final, corrected configuration for your NixOS server. It integrates Conduit, the Cloudflare DDNS updater, Nginx, and the firewall.

```nix
# /etc/nixos/configuration.nix
{ config, pkgs, ... }:

{
  # 1. Conduit Homeserver Configuration
  services.matrix-conduit = {
    enable = true;
    settings = {
      global = {
        server_name = "morpheum.dev";
        database_path = "/var/lib/matrix-conduit";
        port = 6167;
        address = "127.0.0.1";
      };
    };
  };

  # 2. Cloudflare Dynamic DNS Updater
  services.cloudflare-dyndns = {
    enable = true;
    apiTokenFile = "/path/to/your/cloudflare-token-file";
    domains = [ "matrix.morpheum.dev" ];
  };

  # 3. Nginx Reverse Proxy
  services.nginx.virtualHosts."matrix.morpheum.dev" = {
    serverAliases = [ "morpheum.dev" ];
    forceSSL = true;
    
    # Manually link the certificate from the ACME module
    sslCertificate = config.security.acme.certs."matrix.morpheum.dev".directory + "/fullchain.pem";
    sslCertificateKey = config.security.acme.certs."matrix.morpheum.dev".directory + "/key.pem";

    locations = {
      "/_matrix" = {
        proxyPass = "[http://127.0.0.1:6167](http://127.0.0.1:6167)";
        proxyWebsockets = true;
        extraConfig = ''
          proxy_set_header X-Forwarded-For $remote_addr;
          proxy_set_header Host $host;
        '';
      };
      "/.well-known/matrix/server" = {
        return = "200 '{ \"m.server\": \"matrix.morpheum.dev:443\" }'";
        extraConfig = "add_header Content-Type application/json;";
      };
    };
  };

  # 4. Automatic SSL Certificates (ACME / Let's Encrypt)
  security.acme = {
    acceptTOS = true;
    defaults.email = "your-email@example.com";
    certs."matrix.morpheum.dev" = {
      extraDomainNames = [ "morpheum.dev" ];
      dnsProvider = "cloudflare";
      credentialsFile = "/path/to/your/acme-cloudflare.ini";
    };
  };

  # 5. Firewall Configuration
  networking.firewall.allowedTCPPorts = [ 80, 443 ];

  # 6. User and Group Permissions for Nginx
  users.users.nginx.extraGroups = [ "acme" ];
}
```

---

### ## Step 4: Required Credentials Files

You need to create **two separate** credentials files on your server.

**1. For Cloudflare DDNS:**
* **Path:** `/path/to/your/cloudflare-token-file`
* **Content:** This file must contain **only your raw API token**.
  ```
  YOUR_PASTED_API_TOKEN_HERE
  ```

**2. For ACME (Let's Encrypt):**
* **Path:** `/path/to/your/acme-cloudflare.ini`
* **Content:** This file must be in `.ini` format.
  ```ini
  CLOUDFLARE_DNS_API_TOKEN = "YOUR_PASTED_API_TOKEN_HERE"
  ```

---

### ## Step 5: Final Deployment and Verification

1.  Create the two credentials files listed above and ensure they are secure (`sudo chmod 600 ...`).
2.  Apply the configuration: `sudo nixos-rebuild switch --flake .`
3.  **Verify your setup:** Use the **Matrix Federation Tester** at `https://federationtester.matrix.org/`. Enter `morpheum.dev` as the server name.
4.  **Create your first user:** `conduit-admin create-user my-username 'a-very-strong-password'`

You can now log in from any Matrix client by specifying `morpheum.dev` as your homeserver.

---

### ## Things That Went Wrong / Lessons Learned üßê

This setup is complex, and several subtle issues had to be resolved. This section summarizes the key corrections from our debugging session.

1.  **Matrix SRV Record Nuances:** The Matrix specification for federation discovery is nuanced. For maximum compatibility with both old and new servers in a delegated setup, **three SRV records** are recommended: `_matrix-server._tcp` on the root domain, `_matrix-fed._tcp` on the delegated host, and `_matrix._tcp` as a legacy fallback.

2.  **Incorrect NixOS Service Names:** The initial service names were wrong. The correct NixOS options are `services.matrix-conduit` (not `conduit`) and `services.cloudflare-dyndns` (not `cloudflare-ddns`).

3.  **Incorrect NixOS Service Configuration:** Several service parameters were incorrect:
    * The `matrix-conduit` settings must be nested inside a `global` block.
    * The `cloudflare-dyndns` service requires the `apiTokenFile` option, and the file must contain only the raw token.
    * The Nginx `return` directive requires its entire value to be a single string (e.g., `"200 '{...}'"`), with inner quotes escaped.

4.  **ACME Challenge Conflict:** For delegation to a domain you don't host (like GitHub Pages), the ACME SSL certificate **must** be validated using the `DNS-01` challenge (`dnsProvider = "cloudflare"`). This required removing the conflicting `enableACME = true;` option from the Nginx virtual host.

5.  **Broken Certificate Link:** Removing `enableACME` from the Nginx config broke the automatic link between Nginx and the generated SSL certificate. The `sslCertificate` and `sslCertificateKey` options had to be set manually in the Nginx config to fix this.

6.  **File Permissions:** The Nginx service runs as the `nginx` user and couldn't read the certificate files owned by the `acme` user. The solution was to add the `nginx` user to the `acme` group using `users.users.nginx.extraGroups`.
